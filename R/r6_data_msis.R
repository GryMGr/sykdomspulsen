get_county_municip <- function(){
  handle <- handle("http://www.msis.no/StandardRapport.aspx")
  initial <- GET(handle=handle)
  initial_data <- html_form(content(initial))[[1]]$fields
  fylke <- 2996:3017

  out <- list()

  r<- POST(handle=handle,
           body=list(
             "__VIEWSTATE"=initial_data[["__VIEWSTATE"]]$value,
             "__EVENTTARGET"="m_ctrlStandardRapportList",
             m_ctrlStandardRapportList=1,
             m_ctrlYearList=2019,
             "__VIEWSTATEGENERATOR"="D56CFAB9",
             "__EVENTVALIDATION"=initial_data[["__EVENTVALIDATION"]]$value,
             "__EVENTARGUMENT"= "",
             "__LASTFOCUS"=""
             ))
  initial_data <- html_form(content(r))[[1]]$fields
  i <- 1
  counties <- html_form(content(r))[[1]][["fields"]][["m_ctrlFylke"]][["options"]]
  for(name in names(counties)){
    code <- counties[[name]]
    r<- POST(handle=handle,
             body=list(
               "__VIEWSTATE"=initial_data[["__VIEWSTATE"]]$value,
               "__EVENTTARGET"="m_ctrlFylke",
               m_ctrlStandardRapportList=1,
               m_ctrlYearList=2019,
               m_ctrlFylke=code,
               "__VIEWSTATEGENERATOR"="D56CFAB9",
               "__EVENTVALIDATION"=initial_data[["__EVENTVALIDATION"]]$value,
               "__EVENTARGUMENT"= "",
               "__LASTFOCUS"=""
             ))
    municips <- html_form(content(r))[[1]][["fields"]][["m_ctrlKommuner"]][["options"]]
    #print(municips)
    for(m_name in names(municips)){
      #print(m_name)
      #print(municips[m_name])
      out[[i]] <- list(municip=m_name[1], municip_code = municips[[m_name]],
                       county=name[1], county_code=code)
      i = i + 1

    }

  }
  return(out)
}


get_data <- function(x_year, x_county, x_municip){

    handle <- handle("http://www.msis.no/StandardRapport.aspx")
    initial <- GET(handle=handle)
    initial_data <- html_form(content(initial))[[1]]$fields


    intermediate <- POST(handle=handle,
         body=list(
             "__VIEWSTATE"=initial_data[["__VIEWSTATE"]]$value,
          "__EVENTTARGET"="m_ctrlStandardRapportList",
             m_ctrlStandardRapportList=1,
             m_ctrlYearList=2019,
             "__VIEWSTATEGENERATOR"="D56CFAB9",
             "__EVENTVALIDATION"=initial_data[["__EVENTVALIDATION"]]$value,
             "__EVENTARGUMENT"= "",
              "__LASTFOCUS"=""
             ))
    intermediate_data <- html_form(content(intermediate))[[1]]$fields

    intermediate <- POST(handle=handle,
         body=list(
             "__VIEWSTATE"=intermediate_data[["__VIEWSTATE"]]$value,

             "__EVENTTARGET"="m_ctrlFylke",
             m_ctrlStandardRapportList=1,
             m_ctrlYearList=2019,
             m_ctrlFylke=x_county,
             "__VIEWSTATEGENERATOR"="D56CFAB9",
             "__EVENTVALIDATION"=intermediate_data[["__EVENTVALIDATION"]]$value,
             "__EVENTARGUMENT"= "",
              "__LASTFOCUS"=""
             ))
    intermediate_data <- html_form(content(intermediate))[[1]]$fields

    r <- POST(handle=handle,
         body=list(
             "__VIEWSTATE"=intermediate_data[["__VIEWSTATE"]]$value,
             m_ctrlYearList=x_year,
             m_ctrlStandardRapportList=1,
             m_ctrlFylke=x_county,
             m_ctrlKommuner=x_municip,
             m_ctrlMakeTable="Lag Tabell",
             "__VIEWSTATEGENERATOR"="D56CFAB9",
             "__EVENTVALIDATION"=intermediate_data[["__EVENTVALIDATION"]]$value
             )
          )
    a <- XML::readHTMLTable(content(r, "text"))$m_ucReportGrid_m_ctrlRapportGrid
    data <- tidyr::gather(a, "month", "n", -Sykdom)
    setDT(data)
    data[, year:=x_year]
    data[, municip_code:=x_municip]
    data[, county_code:=x_county]
    return(data)
}


clean_data <- function(data){
    months = c("Januar",
             "Februar",
             "Mars",
             "April",
             "Mai",
             "Juni",
             "Juli",
             "August",
             "September",
             "Oktober",
             "November",
             "Desember")

    data[, n:=as.integer(n)]
    data[is.na(n), n:=0]
    data[, date:=as.Date(ISOdate(year,match(month, months), 1))]
    data <- data[!is.na(Sykdom)]
    return(data)
}

#' get_MSIS_data
#'
#' Get and clean MSIS data from msis.no
#'
#' @import httr
#' @import data.table
#' @import rvest
#'
#' @export
r6_data_msis <- R6::R6Class(
  "r6_data_msis",
  inherit = TaskBase,
  portable = FALSE,
  cloneable = FALSE,
  list(
    run = function(){
      # arguments
      start_year <- tc(task_name)$args$start_year
      end_year <- tc(task_name)$args$end_year

      municips <- get_county_municip()[1:10]
      data_list <- list()
      i = 1
      for(m in municips){
        for(year in start_year:end_year){
          new_data <- get_data(year, as.integer(m["county_code"]), as.integer(m["municip_code"]))
      new_data[,county:=m["county"]]
          new_data[,municip:=m["municip"]]
          data_list[[i]] <- new_data
          i = i +1
        }
      }
      data <- rbindlist(data_list)
      cleaned_data <- clean_data(data)
      with_loc <- cleaned_data[fd::norway_locations()[, .(location_code=municip_code, municip_name)], on=c("municip"="municip_name")]
      with_loc[, tag_outcome :=Sykdom]
      with_loc <- with_loc[!is.na(tag_outcome),]
      with_loc[, granularity_time:="month"]
      with_loc[, granularity_geo:="municip"]
      with_loc[, border:=fd::config$border]
      with_loc[, age:="Totalt"]
      with_loc[, sex:="Totalt"]
      with_loc[, year:=lubridate::year(date)]
      msis_data_schema$db_connect(config$db_config)
      out_data <- with_loc[, .(tag_outcome,
                               location_code,
                               granularity_time,
                               granularity_geo,
                               border,
                               month,
                               year,
                               age,
                               sex,
                               date,
                               n)]
      msis_data_schema$db_drop_all_rows()
      msis_data_schema$db_load_data_infile(out_data)
    }
  )
)

msis_data_schema <- fd::schema$new(
    db_table = "data_msis",
    db_field_types =  c(
      "tag_outcome" = "TEXT",
      "location_code" = "TEXT",
      "granularity_time" = "TEXT",
      "granularity_geo" = "TEXT",
      "border" = "INTEGER",
      "age" = "TEXT",
      "sex" = "TEXT",
      "date" = "DATE",
      "season" = "TEXT",
      "yrwk" = "TEXT",
      "year" = "INTEGER",
      "week" = "INTEGER",
      "month" = "TEXT",
      "n" = "INTEGER"
    ),
    db_load_folder = "/xtmp/",
    keys =  c(
      "tag_outcome",
      "location_code",
      "year",
      "date"
    )
)


